name: Build RPM Package

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-rpm:
    runs-on: ubuntu-latest

    container:
      image: rockylinux:9

    steps:
      #  Checkout code
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2Ô∏èInstall required tools
      - name: Install RPM build tools
        run: |
          dnf install -y \
            rpm-build \
            rpmdevtools \
            tar \
            gzip \
            rsync \
            systemd-rpm-macros \
            python3

      #  Create rpmbuild structure and copy spec
      - name: Prepare rpmbuild directories
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp devops/*.spec rpmbuild/SPECS/

      # üî• THIS IS THE IMPORTANT FIX (ADD THIS)
      - name: Fix spec file line endings (CRLF ‚Üí LF)
        run: |
          sed -i 's/\r$//' rpmbuild/SPECS/*.spec
          file rpmbuild/SPECS/*.spec

      # Create source tarball
      - name: Create source tarball
        run: |
          NAME=wiser-service-operations-backend
          VERSION=1.0.0

          mkdir -p /tmp/${NAME}-${VERSION}
          rsync -a . /tmp/${NAME}-
